<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ - 2025</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
:root { --primary:#0a2e38; --gold:#c19a6b; --bg:#f8fafc; }
*{box-sizing:border-box;font-family:'Cairo',sans-serif}
body{background:var(--bg);margin:0;padding-bottom:80px}
#loginOverlay{position:fixed;inset:0;background:var(--primary);z-index:10000;display:flex;align-items:center;justify-content:center}
.login-card{background:white;padding:40px;border-radius:20px;width:90%;max-width:400px;text-align:center;border-top:8px solid var(--gold)}
input,textarea{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:10px;font-size:16px}
.header{background:var(--primary);color:white;padding:20px;text-align:center;border-bottom:5px solid var(--gold);position:sticky;top:0;z-index:1000}
.nav-tools{display:flex;justify-content:center;gap:10px;margin-top:10px}
.btn-tool{background:rgba(255,255,255,0.2);color:white;border:1px solid white;padding:5px 12px;border-radius:20px;cursor:pointer;font-size:12px}
.container{max-width:700px;margin:20px auto;padding:0 15px;display:none}
.card{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
.opt-btn{background:#f1f5f9;padding:10px;text-align:center;border-radius:8px;cursor:pointer;border:2px solid transparent;font-size:14px}
input[type="radio"]{display:none}
input:checked + .ok{background:#dcfce7;color:#166534;border-color:#22c55e}
input:checked + .no{background:#fee2e2;color:#991b1b;border-color:#ef4444}
.violation-box{display:none;background:#fff5f5;padding:15px;border-radius:10px;margin-top:10px;border:1px dashed #ef4444}
.footer{position:fixed;bottom:0;width:100%;background:white;padding:15px;text-align:center;box-shadow:0 -5px 15px rgba(0,0,0,.1)}
.submit-btn{background:var(--gold);color:white;border:none;padding:15px 50px;border-radius:12px;font-weight:bold;width:90%;font-size:18px}
</style>
</head>

<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2>ğŸ›¡ï¸ Ù†Ø¸Ø§Ù… ØªÙØªÙŠØ´ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h2>
        <input type="text" id="uid" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="ups" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button onclick="doLogin()" style="width:100%;padding:15px;background:var(--primary);color:white;border:none;border-radius:10px;font-weight:bold">Ø¯Ø®ÙˆÙ„ ğŸš€</button>
        <p id="lErr" style="color:red;display:none">âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©</p>
    </div>
</div>

<div id="mainApp" class="container">
    <div class="header">
        <h2 id="inspectorLabel"></h2>
        <div class="nav-tools">
            <button class="btn-tool" onclick="changeMyPass()">ğŸ”‘ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±</button>
            <button class="btn-tool" style="background:#ef4444" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

<form id="safetyForm">
    <div class="card">
        <h3>ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
        <input type="date" id="rDate" name="report_date" required>
        <input name="location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹" required>
        <input name="job_order" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø©" required>
    </div>

    <div id="questionsContainer"></div>

    <div class="footer">
        <button class="submit-btn" id="sBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸš€</button>
    </div>
</form>
</div>

<script>
/* ğŸ” Redis */
const REDIS_URL="https://exact-parakeet-58043.upstash.io";
const REDIS_TOKEN="AeK7AAIncDFmOTAzMGJlOTM5Y2I0ZTFjYTg4ODRhOWIyNjJmZWMwY3AxNTgwNDM";

/* â“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
const qList=[
"ØªØµØ±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„Ø«Ø§Ù†ÙˆÙŠ Ù…ØªÙˆØ§Ø¬Ø¯",
"Ø§Ø¬ØªÙ…Ø§Ø¹ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ (TBT)"
];

async function doLogin(){
    const u=document.getElementById('uid').value;
    const p=document.getElementById('ups').value;
    const res = await fetch(`${REDIS_URL}/get/user:${u}`, { headers:{Authorization:`Bearer ${REDIS_TOKEN}`}});
    const data = await res.json();
    if(data.result === p){
        sessionStorage.setItem("inspector", u);
        startApp(u);
    } else {
        document.getElementById('lErr').style.display='block';
    }
}

function startApp(user){
    document.getElementById('loginOverlay').style.display='none';
    document.getElementById('mainApp').style.display='block';
    document.getElementById('inspectorLabel').innerText = "Ø§Ù„Ù…ÙØªØ´: " + user;
    document.getElementById('rDate').valueAsDate = new Date();
    loadQuestions();
}

function loadQuestions(){
    const container = document.getElementById('questionsContainer');
    container.innerHTML = "";
    qList.forEach((qText, i)=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML=`
        <p><b>${i+1}. ${qText}</b></p>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
            <label><input type="radio" name="q${i}" value="Ø³Ù„ÙŠÙ…" onclick="showV(${i},false)" required><div class="opt-btn ok">Ø³Ù„ÙŠÙ…</div></label>
            <label><input type="radio" name="q${i}" value="Ù…Ø®Ø§Ù„Ù" onclick="showV(${i},true)"><div class="opt-btn no">Ù…Ø®Ø§Ù„Ù</div></label>
            <label><input type="radio" name="q${i}" value="N/A" onclick="showV(${i},false)"><div class="opt-btn">N/A</div></label>
        </div>
        <div id="vbox${i}" class="violation-box">
            <input type="file" id="img${i}" accept="image/*" capture="environment">
            <textarea id="note${i}" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©..."></textarea>
        </div>`;
        container.appendChild(div);
    });
}

function showV(id, show){
    document.getElementById(`vbox${id}`).style.display = show ? 'block' : 'none';
}

const compressImage = (file) => {
    return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e)=>{
            const img = new Image();
            img.src = e.target.result;
            img.onload = ()=>{
                const canvas = document.createElement('canvas');
                const MAX_WIDTH=600;
                const scaleSize = MAX_WIDTH/img.width;
                canvas.width=MAX_WIDTH;
                canvas.height = img.height*scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img,0,0,canvas.width,canvas.height);
                resolve(canvas.toDataURL('image/jpeg',0.6));
            }
        }
    });
}

document.getElementById('safetyForm').onsubmit = async e=>{
    e.preventDefault();
    const btn = document.getElementById('sBtn');
    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

    try{
        const reportId = Date.now();
        const formData = new FormData(e.target);
        const report = {
            serial: reportId,
            inspector: sessionStorage.getItem('inspector'),
            timestamp: new Date().toLocaleString('ar-EG'),
            location: formData.get('location'),
            job_order: formData.get('job_order'),
            report_date: formData.get('report_date'),
            answers:{},
            violations:[]
        };

        for(let i=0;i<qList.length;i++){
            const val = formData.get(`q${i}`);
            report.answers[i] = val;
            if(val==="Ù…Ø®Ø§Ù„Ù"){
                const img = document.getElementById(`img${i}`).files[0];
                report.violations.push({
                    id:i,
                    q:qList[i],
                    note:document.getElementById(`note${i}`).value,
                    photo: img?await compressImage(img):""
                });
            }
        }

        /* Ø­ÙØ¸ ÙÙŠ Redis */
        await fetch(`${REDIS_URL}/set/report:${reportId}`,{
            method:'POST',
            headers:{Authorization:`Bearer ${REDIS_TOKEN}`},
            body: JSON.stringify(report)
        });

        await fetch(`${REDIS_URL}/rpush/reports_list/${reportId}`,{
            method:'POST',
            headers:{Authorization:`Bearer ${REDIS_TOKEN}`}
        });

        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
        location.reload();

    }catch(err){
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        btn.disabled = false;
    }
}

function logout(){sessionStorage.clear();location.reload();}

async function changeMyPass(){
    const u=sessionStorage.getItem('inspector');
    const np = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
    if(np && np.length>=4){
        await fetch(`${REDIS_URL}/set/user:${u}`,{
            method:'POST',
            headers:{Authorization:`Bearer ${REDIS_TOKEN}`},
            body:np
        });
        alert("âœ… ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±");
        logout();
    }
}
</script>
</body>
</html>
