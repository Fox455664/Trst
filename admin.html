<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --sec-blue: #005a8f; --sec-orange: #f28b00; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; }
        
        .admin-header { background: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 5px solid var(--sec-orange); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .admin-header img { height: 50px; }
        .admin-title { color: var(--sec-blue); font-weight: bold; font-size: 18px; }

        .tabs { display: flex; gap: 10px; padding: 20px; max-width: 1200px; margin: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: white; color: var(--sec-blue); border: 1px solid #ddd; transition: 0.3s; }
        .tab-btn.active { background: var(--sec-blue); color: white; }

        .container { max-width: 1200px; margin: auto; padding: 0 20px; }
        .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 20px; outline: none; font-size: 16px; }
        
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-right: 6px solid var(--sec-blue); position: relative; }
        
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 10px; }
        .stat-item { padding: 6px; border-radius: 5px; font-size: 10px; text-align: center; color: white; font-weight: bold; line-height: 1.2; }
        .safe { background: #22c55e; } 
        .danger { background: #ef4444; } 
        .na { background: #94a3b8; }

        .v-card { margin-top: 15px; border: 1px solid #eee; padding: 15px; border-radius: 10px; background: #fffcf5; }
        .img-thumb { width: 150px; height: 150px; object-fit: cover; border-radius: 10px; cursor: pointer; margin-top: 10px; border: 2px solid #ddd; transition: 0.3s; }
        .img-thumb:hover { transform: scale(1.05); }
        
        #imgModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10001; align-items: center; justify-content: center; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-del { background: #fee2e2; color: #ef4444; }
        .btn-del:hover { background: #ef4444; color: white; }
        .btn-print { background: var(--sec-blue); color: white; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .card { border: 1px solid #ccc; box-shadow: none; page-break-inside: avoid; margin-bottom: 50px; }
            details { display: block !important; }
            details summary { display: none; }
            .status-grid { display: grid !important; }
        }
    </style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="modalImg" src="" style="max-width:95%; max-height:95%; border-radius:10px; box-shadow: 0 0 20px rgba(255,255,255,0.2);">
</div>

<div class="admin-header">
    <img src="imeg/imge.jpg" class="logo-hero" onerror="this.src='https://via.placeholder.com/150x50?text=SEC+LOGO'">
    <div class="admin-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© ğŸ“Š</div>
    <button onclick="logout()" class="btn btn-del no-print">Ø®Ø±ÙˆØ¬ ğŸšª</button>
</div>

<div class="tabs no-print">
    <button onclick="showTab('reps')" id="tR" class="tab-btn active">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="showTab('users')" id="tU" class="tab-btn">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</button>
</div>

<div class="container">
    <div id="viewReps">
        <input type="text" id="searchInput" class="search-box no-print" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ù…ÙØªØ´ØŒ Ø£Ùˆ Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„..." oninput="runSearch()">
        <div id="reportsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±... â³</div>
    </div>

    <div id="viewUsers" style="display:none">
        <div class="card no-print">
            <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù…</h3>
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <input type="text" id="nu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="flex:1; min-width:150px;">
                <input type="text" id="np" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="flex:1; min-width:150px;">
                <button onclick="addUser()" class="btn btn-print">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ´</button>
            </div>
        </div>
        <div id="usersList"></div>
    </div>
</div>

<script>
    const REDIS_URL = "https://exact-parakeet-58043.upstash.io";
    const REDIS_TOKEN = "AeK7AAIncDFmOTAzMGJlOTM5Y2I0ZTFjYTg4ODRhOWIyNjJmZWMwY3AxNTgwNDM";
    let allReports = [];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ù…Ù†
    if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href = 'index.html';

    function showTab(t) {
        document.getElementById('viewReps').style.display = t==='reps'?'block':'none';
        document.getElementById('viewUsers').style.display = t==='users'?'block':'none';
        document.getElementById('tR').className = t==='reps'?'tab-btn active':'tab-btn';
        document.getElementById('tU').className = t==='users'?'tab-btn active':'tab-btn';
        if(t==='users') loadUsers(); else fetchReports();
    }

    async function fetchReports() {
        try {
            const res = await fetch(`${REDIS_URL}/lrange/reports_list/0/-1`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            const ids = (await res.json()).result || [];
            
            const area = document.getElementById('reportsList');
            if(ids.length === 0) { area.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹"; return; }

            allReports = [];
            for(let id of ids) {
                const rRes = await fetch(`${REDIS_URL}/get/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
                const rData = await rRes.json();
                if(rData.result) {
                    try {
                        allReports.push(JSON.parse(rData.result));
                    } catch(e) { console.error("Error parsing report:", id); }
                }
            }
            runSearch();
        } catch(e) { 
            document.getElementById('reportsList').innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; 
        }
    }

    function runSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allReports.filter(r => 
            (r.inspector || "").toLowerCase().includes(term) || 
            (r.serial || "").toString().includes(term) || 
            (r.location || "").toLowerCase().includes(term) ||
            (r.job_order || "").toLowerCase().includes(term)
        );

        const area = document.getElementById('reportsList'); 
        area.innerHTML = "";

        if(filtered.length === 0) { area.innerHTML = "ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«"; return; }

        // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
        [...filtered].reverse().forEach(r => {
            let statusHtml = "";
            if(r.answers) {
                Object.keys(r.answers).forEach(key => {
                    let ans = r.answers[key];
                    let cls = ans === 'Ù†Ø¹Ù…' ? 'safe' : (ans === 'Ù„Ø§' ? 'danger' : 'na');
                    statusHtml += `<div class="stat-item ${cls}">Ø¨Ù†Ø¯ ${key}: ${ans}</div>`;
                });
            }

            let vHtml = "";
            (r.violations || []).forEach(v => {
                vHtml += `
                <div class="v-card">
                    <b style="color:var(--sec-blue)">ğŸ“ Ø¨Ù†Ø¯ ${v.id || v.q_num}: ${v.q || v.question}</b> 
                    <span style="float:left; font-weight:bold; color:${v.ans === 'Ù„Ø§' ? 'red' : 'inherit'}">${v.ans || v.status}</span>
                    <p style="margin: 10px 0 5px 0;">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${v.note || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙƒØªÙˆØ¨Ø©"}</p>
                    ${v.photo ? `<img src="${v.photo}" class="img-thumb" onclick="openImg(this.src)">` : ""}
                </div>`;
            });

            area.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <b>ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø±Ù‚Ù…: ${r.serial}</b>
                        <span>ğŸ•’ ${r.timestamp}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div>ğŸ‘· Ø§Ù„Ù…ÙØªØ´: <b>${r.inspector}</b></div>
                        <div>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: <b>${r.location}</b></div>
                        <div>ğŸ“„ Ø§Ù„Ù…Ù‡Ù…Ø©/Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„: <b>${r.job_order}</b></div>
                        <div>ğŸ˜ï¸ Ø§Ù„Ø­ÙŠ: <b>${r.district || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</b></div>
                    </div>

                    <details class="no-print" style="margin-top:15px;">
                        <summary style="cursor:pointer; color:var(--sec-orange); font-weight:bold;">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ (34 Ø¨Ù†Ø¯)</summary>
                        <div class="status-grid">${statusHtml}</div>
                    </details>
                    
                    <div class="print-only-grid status-grid" style="display:none;">${statusHtml}</div>

                    <div style="margin-top:20px">
                        <h4 style="margin-bottom:10px; color:var(--sec-blue); border-bottom: 1px solid #eee;">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø©:</h4>
                        ${vHtml || "<p style='color:gray'>âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØµÙˆØ± Ù…Ø±ÙÙ‚Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>"}
                    </div>

                    <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
                        <button class="btn btn-print" onclick="preparePrint(this)">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸ–¨ï¸</button>
                        <button class="btn btn-del" onclick="deleteRep('${r.serial}')">Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ—‘ï¸</button>
                    </div>
                </div>`;
        });
    }

    function preparePrint(btn) {
        // ÙØªØ­ Ø§Ù„Ù€ details ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        const card = btn.closest('.card');
        const det = card.querySelector('details');
        if(det) det.open = true;
        window.print();
    }

    function openImg(s) { 
        document.getElementById('modalImg').src = s; 
        document.getElementById('imgModal').style.display = 'flex'; 
    }

    function logout() { sessionStorage.clear(); window.location.href='index.html'; }

    async function deleteRep(id) {
        if(confirm("â— Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
            try {
                await fetch(`${REDIS_URL}/del/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
                await fetch(`${REDIS_URL}/lrem/reports_list/0/${id}`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                fetchReports();
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù"); }
        }
    }

    async function loadUsers() {
        const res = await fetch(`${REDIS_URL}/smembers/inspectors`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        const users = (await res.json()).result || [];
        const area = document.getElementById('usersList'); 
        area.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†...";
        
        let html = "";
        for(let u of users) {
            const pRes = await fetch(`${REDIS_URL}/get/user:${u}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            const pData = await pRes.json();
            html += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ‘¤ Ø§Ù„Ù…ÙØªØ´: <b>${u}</b> | ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: <b style="color:var(--sec-blue)">${pData.result}</b></span>
                    <button class="btn btn-del" onclick="delUser('${u}')">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ´ ğŸ—‘ï¸</button>
                </div>`;
        }
        area.innerHTML = html || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ´ÙŠÙ† Ù…Ø¶Ø§ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹";
    }

    async function addUser() {
        const u = document.getElementById('nu').value.trim(); 
        const p = document.getElementById('np').value.trim();
        if(!u || !p) { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
        
        await fetch(`${REDIS_URL}/set/user:${u}`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: p });
        await fetch(`${REDIS_URL}/sadd/inspectors`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: u });
        
        document.getElementById('nu').value=""; 
        document.getElementById('np').value=""; 
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ´ Ø¨Ù†Ø¬Ø§Ø­");
        loadUsers();
    }

    async function delUser(u) {
        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø­Ø¸Ø± Ø§Ù„Ù…ÙØªØ´ (${u}) Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ`)) {
            await fetch(`${REDIS_URL}/del/user:${u}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            await fetch(`${REDIS_URL}/srem/inspectors`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: u });
            loadUsers();
        }
    }

    // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    fetchReports();
</script>
</body>
</html>
