<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Ù…ÙƒØªØ¨Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ù„Ø¹ÙŠÙ† -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sec-blue: #005a8f; --sec-orange: #f28b00; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; }
        
        .admin-header { background: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 5px solid var(--sec-orange); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-left-box { border: 2px solid var(--sec-blue); padding: 5px 10px; border-radius: 8px; text-align: center; color: var(--sec-blue); font-weight: bold; font-size: 11px; background: #f8fafc; }
        
        .tabs { display: flex; gap: 10px; padding: 20px; max-width: 1200px; margin: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: white; color: var(--sec-blue); border: 1px solid #ddd; }
        .tab-btn.active { background: var(--sec-blue); color: white; }

        .container { max-width: 1200px; margin: auto; padding: 0 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-right: 6px solid var(--sec-blue); }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ù†Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø¹ Ø§Ù„Ø¹ÙŠÙ† */
        .input-group { position: relative; flex: 1; min-width: 200px; }
        .input-group input { width: 100%; padding: 12px; padding-left: 40px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .toggle-password { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; }

        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; transition: 0.3s; }
        .user-row:hover { background: #f8fafc; }
        .user-actions { display: flex; gap: 8px; }

        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-del { background: #fee2e2; color: #ef4444; }
        .btn-edit { background: #e0f2fe; color: #0284c7; }
        .btn-save { background: var(--sec-blue); color: white; width: 100%; margin-top: 10px; }

        .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 20px; outline: none; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="admin-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="imeg/imge.jpg" style="height:45px">
        <b style="color:var(--sec-blue)">Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©</b>
    </div>
    <div class="header-left-box">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©<br>Ø¥Ø¯Ø§Ø±Ø© Ø¶ÙˆØ§Ø­ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶</div>
    <button onclick="logout()" class="btn btn-del no-print">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="tabs no-print">
    <button onclick="showTab('reps')" id="tR" class="tab-btn active">ğŸ“‹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="showTab('users')" id="tU" class="tab-btn">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</button>
</div>

<div class="container">
    <div id="viewReps">
        <input type="text" id="searchInput" class="search-box no-print" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ù…ÙØªØ´ØŒ Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„..." oninput="runSearch()">
        <div id="reportsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</div>
    </div>

    <div id="viewUsers" style="display:none">
        <div class="card">
            <h3 id="userFormTitle" style="color:var(--sec-blue); margin-top:0;">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´ Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <input type="text" id="nu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)" style="flex:1; min-width:200px; padding:12px; border-radius:8px; border:1px solid #ddd;">
                
                <div class="input-group">
                    <input type="password" id="np" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                    <i class="fa-solid fa-eye toggle-password" onclick="togglePassView('np', this)"></i>
                </div>
            </div>
            <button onclick="addUser()" class="btn btn-save" id="btnUserAction">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…</button>
            <button onclick="resetUserForm()" id="btnCancelEdit" style="display:none; width:100%; margin-top:5px; background:none; border:none; color:gray; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <div class="card">
            <h3 style="color:var(--sec-blue)">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
            <div id="usersList"></div>
        </div>
    </div>
</div>

<script>
    const REDIS_URL = "https://exact-parakeet-58043.upstash.io";
    const REDIS_TOKEN = "AeK7AAIncDFmOTAzMGJlOTM5Y2I0ZTFjYTg4ODRhOWIyNjJmZWMwY3AxNTgwNDM";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
    if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href = 'index.html';

    function showTab(t) {
        document.getElementById('viewReps').style.display = t==='reps'?'block':'none';
        document.getElementById('viewUsers').style.display = t==='users'?'block':'none';
        document.getElementById('tR').className = t==='reps'?'tab-btn active':'tab-btn';
        document.getElementById('tU').className = t==='users'?'tab-btn active':'tab-btn';
        if(t==='users') loadUsers(); else fetchReports();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    function togglePassView(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
        }
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
    async function loadUsers() {
        const uListArea = document.getElementById('usersList');
        uListArea.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        try {
            const res = await fetch(`${REDIS_URL}/keys/user:*`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            const keys = (await res.json()).result || [];
            let html = "";
            for(let k of keys) {
                const username = k.split(':')[1];
                html += `
                <div class="user-row">
                    <span>ğŸ‘¤ <b>${username}</b></span>
                    <div class="user-actions">
                        <button class="btn btn-edit" onclick="prepareEdit('${username}')"><i class="fa-solid fa-key"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</button>
                        <button class="btn btn-del" onclick="delUser('${k}')"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
                    </div>
                </div>`;
            }
            uListArea.innerHTML = html || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ´ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹";
        } catch(e) { uListArea.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"; }
    }

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    function prepareEdit(user) {
        document.getElementById('nu').value = user;
        document.getElementById('nu').readOnly = true; // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„Ø§Ø³Ù…ØŒ Ù†ØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙ‚Ø·
        document.getElementById('userFormTitle').innerText = "ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø±: " + user;
        document.getElementById('btnUserAction').innerText = "ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ğŸ’¾";
        document.getElementById('btnCancelEdit').style.display = "block";
        document.getElementById('np').focus();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetUserForm() {
        document.getElementById('nu').value = "";
        document.getElementById('nu').readOnly = false;
        document.getElementById('np').value = "";
        document.getElementById('userFormTitle').innerText = "â• Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´ Ø¬Ø¯ÙŠØ¯";
        document.getElementById('btnUserAction').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…";
        document.getElementById('btnCancelEdit').style.display = "none";
    }

    async function addUser() {
        const u = document.getElementById('nu').value.trim();
        const p = document.getElementById('np').value.trim();
        if(!u || !p) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");

        try {
            // ÙÙŠ RedisØŒ Ø§Ù„Ù€ SET ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            await fetch(`${REDIS_URL}/set/user:${u}`, { 
                method: 'POST', 
                headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, 
                body: p 
            });
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØªØ´ Ø¨Ù†Ø¬Ø§Ø­");
            resetUserForm();
            loadUsers();
        } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
    }

    async function delUser(key) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ´ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await fetch(`${REDIS_URL}/del/${key}`, { method:'POST', headers:{Authorization:`Bearer ${REDIS_TOKEN}`} });
            loadUsers();
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() { sessionStorage.clear(); window.location.href='index.html'; }

    // (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± fetchReports, runSearch... ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    // Ø³Ø£Ø¶Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„ØµÙØ­Ø©
    async function fetchReports() {
        document.getElementById('reportsList').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        const res = await fetch(`${REDIS_URL}/lrange/reports_list/0/-1`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        const ids = (await res.json()).result || [];
        allReports = [];
        for(let id of ids) {
            const rRes = await fetch(`${REDIS_URL}/get/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            const rJson = await rRes.json();
            if(rJson.result) allReports.push(JSON.parse(rJson.result));
        }
        runSearch();
    }

    function runSearch() {
        // ... (ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹Ø±Ø¶ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        const term = document.getElementById('searchInput').value.toLowerCase();
        const area = document.getElementById('reportsList'); area.innerHTML = "";
        const filtered = allReports.filter(r => (r.inspector||"").toLowerCase().includes(term) || (r.location||"").toLowerCase().includes(term));
        filtered.reverse().forEach(r => {
            area.innerHTML += `<div class="card"><b>ğŸ“„ ØªÙ‚Ø±ÙŠØ± #${r.serial}</b><br>Ø§Ù„Ù…ÙØªØ´: ${r.inspector} | Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${r.location}</div>`;
        });
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    fetchReports();
</script>
</body>
</html>
